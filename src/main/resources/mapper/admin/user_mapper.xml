<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>

<mapper namespace="com.fitmate.admin.dao.UserDAO">

    <!-- 사용자 목록 -->
    <select id="userAllCount" resultType="int">
        SELECT CEIL(COUNT(user_id) / #{param1}) FROM member
    </select>

    <select id="userCountIdx" resultType="int">
        SELECT COUNT(user_id) FROM member
    </select>

    <select id="userList" resultType="com.fitmate.member.dto.MemberDTO">
        SELECT m.user_id, m.nick, m.name, m.email, m.birthday, p.profile,
            (SELECT MAX(date) FROM crew_board WHERE board_id = m.user_id) AS 'last_regdate'
            FROM member m JOIN profile p ON m.user_id = p.user_id
            <where>
                <if test="param4 != null and !param4.equals('') and param3.equals('user_id')">
                    m.user_id LIKE CONCAT('%', #{param4}, '%')
                </if>
                <if test="param4 != null and !param4.equals('') and param3.equals('nick')">
                    m.nick LIKE CONCAT('%', #{param4}, '%')
                </if>
                <if test="param4 != null and !param4.equals('') and param3.equals('name')">
                    m.name LIKE CONCAT('%', #{param4}, '%')
                </if>
                <if test="param4 != null and !param4.equals('') and param3.equals('email')">
                    m.email LIKE CONCAT('%', #{param4}, '%')
                </if>
            </where>
            LIMIT #{param2} OFFSET #{param1}
    </select>

    <!-- 사용자 조회 -->
    <select id="userDetail"  resultType="com.fitmate.member.dto.MemberDTO">
    SELECT m.user_id, m.nick, m.name, m.email, m.birthday, p.status, p.profile, p.regions_idx,
        (SELECT r.region_idx FROM region r JOIN region_sub rs ON r.region_idx = rs.region_idx WHERE rs.regions_idx = p.regions_idx) AS 'region_idx',
        (SELECT r.region_name FROM region r JOIN region_sub rs ON r.region_idx = rs.region_idx WHERE rs.regions_idx = p.regions_idx) AS 'region_name',
        (SELECT rs.regions_name FROM region_sub rs WHERE rs.regions_idx = p.regions_idx) AS 'regions_name',
        (SELECT mb.mbtir_name FROM mbti_r mb WHERE mb.mbtir_idx = p.mbtir_idx) AS 'mbtir_name',
        (SELECT MAX(date) FROM crew_board WHERE board_id = m.user_id) AS 'last_regdate'
        FROM member m JOIN profile p ON m.user_id = p.user_id WHERE m.user_id = #{param}
    </select>

</mapper>